{% extends 'base.html' %}

{% block content %}

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#137fec',
                    slate: {
                        50: '#f8fafc',
                        100: '#f1f5f9',
                        200: '#e2e8f0',
                        300: '#cbd5e1',
                        400: '#94a3b8',
                        500: '#64748b',
                        600: '#475569',
                        700: '#334155',
                        800: '#1e293b',
                        900: '#0f172a',
                    }
                },
                fontFamily: {
                    sans: ['Public Sans', 'sans-serif'],
                }
            }
        }
    }
</script>
<style data-purpose="custom-transitions">
    /* Quitar los bordes redondeados feos de Leaflet y usar los de MAIS */
    .custom-mais-popup .leaflet-popup-content-wrapper {
        border-radius: 1rem !important;
        padding: 0 !important;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1) !important;
    }

    .custom-mais-popup .leaflet-popup-content {
        margin: 12px !important;
        width: 240px !important;
    }

    .custom-mais-popup .leaflet-popup-tip {
        background: white;
    }

    .step-content {
        display: none;
        animation: fadeIn 0.4s ease-out;
    }

    .step-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stepper-line {
        transition: width 0.3s ease-in-out;
    }

    .recipe-preview-card {
        background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
        border: 2px dashed #cbd5e1;
    }
</style>

<main class="max-w-6xl mx-auto px-4 py-8">
    {% if messages %}
    <div class="">
        {% for message in messages %}
        <div class="group relative overflow-hidden p-4 rounded-2xl mb-4 flex items-center justify-between border shadow-sm transition-all duration-300 animate-fadeIn
            {% if message.tags == 'success' %}
                bg-emerald-50/50 text-emerald-800 border-emerald-100 border-l-4 border-l-emerald-500
            {% else %}
                bg-rose-50/50 text-rose-800 border-rose-100 border-l-4 border-l-rose-500
            {% endif %}">

            <div class="flex items-center gap-4">
                <div
                    class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center 
                    {% if message.tags == 'success' %} bg-emerald-100 text-emerald-600 {% else %} bg-rose-100 text-rose-600 {% endif %}">
                    {% if message.tags == 'success' %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    {% endif %}
                </div>

                <div>
                    <p class="text-sm font-semibold leading-none mb-1 capitalize">
                        {% if message.tags == 'success' %}¬°√âxito!{% else %}Atenci√≥n{% endif %}
                    </p>
                    <p class="text-sm opacity-90">{{ message }}</p>
                </div>
            </div>

            <button
                onclick="this.closest('.animate-fadeIn').style.opacity='0'; setTimeout(() => this.closest('.animate-fadeIn').remove(), 300)"
                class="p-2 rounded-lg transition-colors 
                {% if message.tags == 'success' %} hover:bg-emerald-100 text-emerald-400 hover:text-emerald-600 
                {% else %} hover:bg-rose-100 text-rose-400 hover:text-rose-600 {% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- BEGIN: StepperIndicator -->
    <section class="mb-10" data-purpose="progress-tracker">

        <div class="relative flex justify-between items-center max-w-2xl mx-auto">
            <!-- Background Line -->
            <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2 z-0"></div>
            <!-- Progress Line (Controlled by JS) -->
            <div class="absolute top-1/2 left-0 w-0 h-1 bg-primary -translate-y-1/2 z-0 stepper-line"
                id="stepper-progress">
            </div>
            <!-- Step 1 -->
            <div class="relative z-10 flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md ring-4 ring-white"
                    id="step-dot-1">1</div>
                <span class="text-xs font-semibold text-slate-600">Paciente</span>
            </div>
            <!-- Step 2 -->
            <div class="relative z-10 flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold shadow-md ring-4 ring-white"
                    id="step-dot-2">2</div>
                <span class="text-xs font-semibold text-slate-400">Activo</span>
            </div>
            <!-- Step 3 -->
            <div class="relative z-10 flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold shadow-md ring-4 ring-white"
                    id="step-dot-3">3</div>
                <span class="text-xs font-semibold text-slate-400">Receta</span>
            </div>
        </div>
    </section>
    <!-- END: StepperIndicator -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <form method="POST" action="{% url 'create_recipe' %}" id="main-recipe-form">
            {% csrf_token %}
            <input type="hidden" name="paciente_id" id="hidden-paciente-id">
            <input type="hidden" name="activo_id" id="hidden-activo-id">
            <!-- BEGIN: Step1 - Search Patient -->
            <section class="step-content active p-8 md:p-12" id="step-1">
                <div class="max-w-xl mx-auto text-center">
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">Identificar Paciente</h2>
                    <p class="text-slate-500 mb-8">Ingrese el RUT del paciente para iniciar la prescripci√≥n social.</p>
                    <div class="relative mb-8">
                        <input
                            class="w-full px-6 py-4 text-xl rounded-xl border-slate-200 focus:ring-primary focus:border-primary transition-all"
                            id="rut-search" placeholder="12.345.678-9" type="text" />
                        <button type="button"
                            class="absolute right-3 top-3 bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors"
                            onclick="searchPatient()">Buscar</button>
                    </div>
                    <!-- Patient Card (Hidden initially) -->
                    <div class="hidden text-left bg-slate-50 border border-slate-200 rounded-xl p-6 mb-8 animate-fadeIn"
                        id="patient-card">
                        <div class="flex items-start gap-4">
                            <div
                                class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center text-slate-500 text-2xl font-bold">
                                JD
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-slate-900">Juan Delgado P√©rez</h3>
                                <p class="text-slate-500 text-sm mb-4">RUT: 12.345.678-9</p>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="block text-xs uppercase text-slate-400 font-bold">Edad</span>
                                        <span class="text-slate-700 font-medium">67 a√±os</span>
                                    </div>
                                    <div>
                                        <span class="block text-xs uppercase text-slate-400 font-bold">Sector</span>
                                        <span class="text-slate-700 font-medium">Santa Julia</span>
                                    </div>
                                    <div class="col-span-2">
                                        <span class="block text-xs uppercase text-slate-400 font-bold">Direcci√≥n</span>
                                        <span class="text-slate-700 font-medium">Calle Los Aromos #452, Depto 12</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="button"
                            class="px-10 py-3 bg-slate-100 text-slate-400 rounded-xl font-bold cursor-not-allowed transition-all"
                            disabled="" id="next-1" onclick="goToStep(2)">Siguiente</button>
                    </div>
                </div>
            </section>
            <!-- END: Step1 -->
            <!-- BEGIN: Step2 - Community Assets -->
            <section class="step-content p-8" id="step-2">
                <div class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Seleccionar Activo Comunitario</h2>
                        <p class="text-slate-500 text-sm">Activos cercanos al domicilio en Santa Julia</p>
                    </div>
                    <div class="flex gap-2">
                        <select class="rounded-lg border-slate-200 text-sm">
                            <option>Todas las Categor√≠as</option>
                            <option>Actividad F√≠sica</option>
                            <option>Talleres Manuales</option>
                            <option>Apoyo Emocional</option>
                        </select>
                        <select class="rounded-lg border-slate-200 text-sm">
                            <option>Cercan√≠a</option>
                            <option>Disponibilidad</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="assets-grid">
                    <!-- Asset Card 1 -->
                    {% for activo in activos %}
                    <div class="group border border-slate-200 rounded-xl overflow-hidden hover:border-primary transition-all cursor-pointer bg-white"
                        onclick="selectAsset(this, '{{ activo.nombre }}', '{{ activo.id }}')">
                        <img alt="Yoga"
                            class="w-full h-40 object-cover grayscale group-hover:grayscale-0 transition-all"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuD2vkSplnlGhsxUzZEKTI-0YnFfehWG0PUzg_VNEGfN8vlUlfcHFl_SipPduIJumNkONPKN0jB77U-qaw807bOjLEOshc2RGAAp5juehoOl04yAQMtHnESyspM3XOReRUEGJ-CxxJay1Gmn7wJZsCkaunXJMRSqILc6eHyMj75bUi5fYxiLwwUO6F2W3ytAlhx3CDmeS8pCoivk0lyQGSOd2a14lPTwvZKpqG3Aga6TpYffNty_23UphEAedlUGfrjudFlLoA642oQ" />
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <span
                                    class="bg-blue-50 text-primary text-[10px] font-bold uppercase px-2 py-1 rounded">Actividad
                                    F√≠sica</span>
                                <span class="text-xs font-semibold text-slate-500">450m de distancia</span>
                            </div>
                            <h4 class="font-bold text-slate-900 mb-1">Taller de Yoga Adulto Mayor</h4>
                            <p class="text-slate-500 text-xs line-clamp-2">Mejora de movilidad y equilibrio en sede
                                vecinal 14.
                                Monitoreado por kinesi√≥logo.</p>
                            <div class="mt-4 flex items-center text-xs text-slate-400 gap-2">
                                <span class="flex items-center gap-1">üïí Mar-Jue 10:00</span>
                                <span>‚Ä¢</span>
                                <span>Gratuito</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                </div>
                <div class="flex justify-between pt-4 border-t border-slate-100">
                    <button type="button"
                        class="px-6 py-2 text-slate-500 font-bold hover:text-slate-800 transition-colors"
                        onclick="goToStep(1) ">‚Üê Volver
                    </button>
                    <button type="button"
                        class="px-10 py-3 bg-slate-100 text-slate-400 rounded-xl font-bold cursor-not-allowed transition-all"
                        disabled="" id="next-2" onclick="goToStep(3)">Siguiente
                    </button>
                </div>
            </section>
            <!-- END: Step2 -->
            <!-- BEGIN: Step3 - Final Recipe Form -->
            <section class="step-content p-8" id="step-3">
                <div class="flex flex-col lg:flex-row gap-12">
                    <!-- Form Left -->
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold text-slate-900 mb-6">Detalles de la Receta</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Objetivo de Salud</label>
                                <textarea name="objetivo_salud"
                                    class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                    id="health-goal"
                                    placeholder="Ej: Reducir aislamiento social y mejorar movilidad articular..."
                                    rows="3"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Frecuencia</label>
                                    <select name="frecuencia"
                                        class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                        id="frequency">
                                        <option>1 vez por semana</option>
                                        <option selected="">2 veces por semana</option>
                                        <option>Diario</option>
                                        <option>Fin de semana</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Duraci√≥n sugerida</label>
                                    <select name="duracion"
                                        class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                        id="duration">
                                        <option>3 meses</option>
                                        <option selected="">Indefinido</option>
                                        <option>Ciclo de 8 sesiones</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Recomendaciones
                                    adicionales</label>
                                <input name="notas_adicionales"
                                    class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                    id="notes" placeholder="Ej: Llevar botella de agua y ropa c√≥moda" type="text" />
                            </div>
                        </div>
                        <div class="flex justify-between mt-12 pt-6 border-t border-slate-100">
                            <button class="px-6 py-2 text-slate-500 font-bold hover:text-slate-800 transition-colors"
                                onclick="goToStep(2)">‚Üê Volver</button>
                            <button type="submit"
                                class="px-10 py-3 bg-primary text-white rounded-xl font-bold hover:bg-blue-600 shadow-lg shadow-blue-200 transition-all" ">Emitir Receta Social</button>
                        </div>
                    </div>
                    <!-- Preview Right -->
                    <div class=" lg:w-80 flex flex-col items-center">
                                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">
                                    Previsualizaci√≥n en
                                    Vivo</h3>
                                <!-- BEGIN: Live Preview Card -->
                                <div class="recipe-preview-card w-full max-w-[300px] p-6 rounded-2xl shadow-xl relative overflow-hidden"
                                    data-purpose="invitation-card">
                                    <div class="absolute top-0 left-0 w-full h-2 bg-primary"></div>
                                    <div class="text-center mb-6">
                                        <p class="text-[10px] font-bold text-primary uppercase mb-1">Receta para el
                                            Bienestar
                                        </p>
                                        <h4 class="text-lg font-bold text-slate-900 leading-tight">Invitaci√≥n de Salud
                                        </h4>
                                    </div>
                                    <div class="space-y-4 mb-6">
                                        <div class="border-b border-slate-100 pb-2">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold">Paciente</p>
                                            <p class="text-sm font-bold text-slate-800" id="preview-name">Juan Delgado
                                                P.</p>
                                        </div>
                                        <div class="border-b border-slate-100 pb-2">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold">Actividad Prescrita
                                            </p>
                                            <p class="text-sm font-bold text-primary" id="preview-asset">Seleccione
                                                activo...
                                            </p>
                                        </div>
                                        <div>
                                            <p class="text-[9px] text-slate-400 uppercase font-bold">Indicaci√≥n</p>
                                            <p class="text-xs text-slate-600 italic" id="preview-goal">Complete el
                                                objetivo...
                                            </p>
                                        </div>
                                    </div>
                                    <div
                                        class="mt-4 p-4 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 group/pdf relative">
                                        <div class="flex flex-col items-center gap-2">
                                            <div
                                                class="relative w-16 h-20 bg-white shadow-sm border border-slate-200 rounded-sm flex flex-col p-2 overflow-hidden group-hover/pdf:shadow-md transition-shadow">
                                                <div class="w-full h-1.5 bg-primary/20 rounded-full mb-1"></div>
                                                <div class="w-3/4 h-1 bg-slate-100 rounded-full mb-1"></div>
                                                <div class="w-full h-1 bg-slate-100 rounded-full mb-3"></div>

                                                <div class="w-full h-1 bg-slate-50 rounded-full mb-1"></div>
                                                <div class="w-full h-1 bg-slate-50 rounded-full mb-1"></div>

                                                <div
                                                    class="absolute bottom-1 right-1 bg-rose-500 text-[6px] text-white px-1 py-0.5 rounded font-black">
                                                    PDF
                                                </div>

                                                <div
                                                    class="absolute inset-0 bg-primary/5 opacity-0 group-hover/pdf:opacity-100 transition-opacity">
                                                </div>
                                            </div>

                                            <div class="text-center">
                                                <p
                                                    class="text-[9px] font-black text-slate-500 uppercase tracking-tighter">
                                                    Formato de Impresi√≥n</p>
                                                <p class="text-[8px] text-slate-400 leading-tight">Documento oficial A4
                                                    con<br>timbre y firma digital</p>
                                            </div>
                                        </div>

                                        <div
                                            class="absolute -top-2 -right-2 bg-emerald-500 text-white rounded-full p-1 shadow-lg opacity-0 group-hover/pdf:opacity-100 transition-all transform translate-y-2 group-hover/pdf:translate-y-0">
                                            <span class="material-symbols-outlined text-xs">download</span>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-center">
                                        <p class="text-[10px] text-slate-400">Emitido por: Dr. Ricardo Lagos<br />CESFAM
                                            Santa
                                            Julia</p>
                                    </div>
                                </div>
                                <!-- END: Live Preview Card -->
                        </div>
                    </div>
            </section>
            <!-- END: Step3 -->
        </form>
    </div>

    <div id="modal-paciente"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 flex items-center justify-center p-4 sm:p-6">
        <div
            class="p-5 bg-white rounded-3xl shadow-2xl border border-slate-100 w-full max-w-lg overflow-hidden transform transition-all animate-fadeIn">

            <div class="bg-white ">

                <div class="px-8 py-6 border-b border-slate-100 bg-white flex justify-between items-center ">
                    <div>
                        <h3 class="text-2xl font-extrabold text-slate-800 tracking-tight">Nuevo Paciente</h3>
                        <p class="text-sm text-slate-500">Ingresa los datos b√°sicos para el registro.</p>
                    </div>
                    <button onclick="closeModal()"
                        class="p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="form-registro-rapido" class="p-8 space-y-6">
                    {% csrf_token %}

                    <div class="space-y-5">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 group-focus-within:text-blue-500 transition-colors">RUT</label>
                            <input type="text" name="rut" id="modal-rut"
                                class="w-full px-4 py-3 rounded-2xl border-slate-200 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all outline-none"
                                placeholder="12.345.678-9" required>
                        </div>

                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 group-focus-within:text-blue-500 transition-colors">Nombre
                                Completo</label>
                            <input type="text" name="nombre"
                                class="w-full px-4 py-3 rounded-2xl border-slate-200 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all outline-none"
                                placeholder="Ej: Juan P√©rez" required>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="group">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 group-focus-within:text-blue-500 transition-colors">F.
                                    Nacimiento</label>
                                <input type="date" name="fecha_nacimiento"
                                    class="w-full px-4 py-3 rounded-2xl border-slate-200 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all outline-none text-slate-600"
                                    required>
                            </div>
                            <div class="group">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 group-focus-within:text-blue-500 transition-colors">Sector</label>
                                <select name="sector"
                                    class="w-full px-4 py-3 rounded-2xl border-slate-200 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all outline-none text-slate-600 appearance-none">
                                    <option value="Santa Julia">Santa Julia</option>
                                    <option value="Achupallas">Achupallas</option>
                                    <option value="Miraflores">Miraflores</option>
                                </select>
                            </div>
                        </div>

                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 group-focus-within:text-blue-500 transition-colors">Direcci√≥n</label>
                            <input type="text" name="direccion"
                                class="w-full px-4 py-3 rounded-2xl border-slate-200 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all outline-none"
                                placeholder="Calle #123" required>
                        </div>
                    </div>

                    <div class="pt-6 flex flex-col sm:flex-row gap-3">
                        <button type="button" onclick="closeModal()"
                            class="order-2 sm:order-1 flex-1 px-6 py-3.5 text-slate-500 font-semibold hover:bg-slate-100 rounded-2xl transition-all">
                            Cancelar
                        </button>
                        <button type="submit"
                            class="order-1 sm:order-2 flex-[1.5] px-6 py-3.5 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 hover:shadow-xl hover:shadow-blue-200 transform hover:-translate-y-0.5 transition-all">
                            Guardar y Seleccionar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</main>
<script data-purpose="stepper-logic">
    let currentStep = 1;

    // Navegaci√≥n entre pasos
    function goToStep(step) {
        document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${step}`).classList.add('active');
        updateStepperUI(step);
        currentStep = step;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateStepperUI(step) {
        const progress = document.getElementById('stepper-progress');
        progress.style.width = `${(step - 1) * 50}%`;

        for (let i = 1; i <= 3; i++) {
            const dot = document.getElementById(`step-dot-${i}`);
            const label = dot.nextElementSibling;
            if (i < step) {
                dot.classList.replace('bg-slate-200', 'bg-primary');
                dot.classList.replace('text-slate-500', 'text-white');
                dot.innerHTML = '‚úì';
            } else if (i === step) {
                dot.classList.add('bg-primary', 'text-white');
                dot.innerHTML = i;
                label.classList.replace('text-slate-400', 'text-slate-600');
            } else {
                dot.classList.replace('bg-primary', 'bg-slate-200');
                dot.classList.replace('text-white', 'text-slate-500');
                dot.innerHTML = i;
                label.classList.replace('text-slate-600', 'text-slate-400');
            }
        }
    }

    // --- PASO 1: B√öSQUEDA DE PACIENTE ---
    async function searchPatient() {
        const rutInput = document.getElementById('rut-search');
        const rut = rutInput.value.trim();
        if (!rut) return;

        try {
            // URL corregida para que coincida con tu vista get_paciente
            const response = await fetch(`{% url 'get_paciente' %}?rut=${rut}`);
            const data = await response.json();

            if (data.success) {
                actualizarUIConPaciente(data);
            } else {
                if (confirm("Paciente no encontrado. ¬øDeseas registrarlo ahora?")) {
                    openModal(rut);
                }
            }
        } catch (e) {
            console.error("Error al buscar:", e);
            alert("Error de conexi√≥n al buscar paciente");
        }
    }

    function actualizarUIConPaciente(paciente) {
        const card = document.getElementById('patient-card');
        card.classList.remove('hidden');

        // Llenar datos en la tarjeta visual
        document.getElementById('hidden-paciente-id').value = paciente.id;
        document.getElementById('preview-name').innerText = paciente.nombre;
        card.querySelector('h3').innerText = paciente.nombre;
        card.querySelector('p').innerText = `RUT: ${paciente.rut}`;

        // Llenar detalles (Edad, Sector, Direcci√≥n)
        const details = card.querySelectorAll('.text-slate-700');
        if (details.length >= 3) {
            details[0].innerText = (paciente.edad || '??') + " a√±os";
            details[1].innerText = paciente.sector || "No asignado";
            details[2].innerText = paciente.direccion || "Sin direcci√≥n";
        }

        // Habilitar bot√≥n "Siguiente"
        const nextBtn = document.getElementById('next-1');
        nextBtn.disabled = false;
        nextBtn.classList.remove('bg-slate-100', 'text-slate-400', 'cursor-not-allowed');
        nextBtn.classList.add('bg-primary', 'text-white');
    }

    // --- REGISTRO DE PACIENTE (MODAL) ---
    function openModal(rut) {
        document.getElementById('modal-rut').value = rut;
        document.getElementById('modal-paciente').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('modal-paciente').classList.add('hidden');
    }

    document.getElementById('form-registro-rapido').onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        try {
            // Usamos la vista de creaci√≥n que ya tienes
            const response = await fetch("{% url 'create_paciente' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            // Si tu vista actual redirige, lo ideal es que devuelva JSON. 
            // Pero para que funcione con lo que tienes:
            if (response.ok) {
                // Forzamos una nueva b√∫squeda para obtener el ID reci√©n creado
                closeModal();
                await searchPatient();
            }
        } catch (error) {
            alert("Error al procesar el registro");
        }
    };

    // --- PASO 2: SELECCI√ìN DE ACTIVO ---
    function selectAsset(element, name, id) {
        document.querySelectorAll('#assets-grid > div').forEach(card => {
            card.classList.remove('ring-4', 'ring-primary', 'border-primary');
        });
        element.classList.add('ring-4', 'ring-primary', 'border-primary');

        document.getElementById('hidden-activo-id').value = id;
        document.getElementById('preview-asset').innerText = name;

        const nextBtn = document.getElementById('next-2');
        nextBtn.disabled = false;
        nextBtn.classList.remove('bg-slate-100', 'text-slate-400', 'cursor-not-allowed');
        nextBtn.classList.add('bg-primary', 'text-white');
    }

    // --- PASO 3: LIVE PREVIEW ---
    document.getElementById('health-goal').addEventListener('input', (e) => {
        document.getElementById('preview-goal').innerText = e.target.value || "Complete el objetivo...";
    });
</script>
<!-- END: Logic Scripts -->
</body>

{% endblock %}