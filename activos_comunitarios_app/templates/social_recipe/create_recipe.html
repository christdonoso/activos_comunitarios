{% extends 'base.html' %}

{% block content %}

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#137fec',
                    slate: {
                        50: '#f8fafc',
                        100: '#f1f5f9',
                        200: '#e2e8f0',
                        300: '#cbd5e1',
                        400: '#94a3b8',
                        500: '#64748b',
                        600: '#475569',
                        700: '#334155',
                        800: '#1e293b',
                        900: '#0f172a',
                    }
                },
                fontFamily: {
                    sans: ['Public Sans', 'sans-serif'],
                }
            }
        }
    }
</script>
<style data-purpose="custom-transitions">
    .step-content {
        display: none;
        animation: fadeIn 0.4s ease-out;
    }

    .step-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stepper-line {
        transition: width 0.3s ease-in-out;
    }

    .recipe-preview-card {
        background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
        border: 2px dashed #cbd5e1;
    }
</style>

<main class="max-w-6xl mx-auto px-4 py-8">
    {% if messages %}
<div class="max-w-6xl mx-auto px-4 mt-4">
    {% for message in messages %}
    <div class="p-4 rounded-xl mb-4 flex items-center justify-between {% if message.tags == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-red-50 text-red-700 border border-red-200{% endif %} shadow-sm animate-fadeIn">
        <div class="flex items-center gap-3">
            {% if message.tags == 'success' %}
                <span class="text-xl">‚úÖ</span>
            {% else %}
                <span class="text-xl">‚ö†Ô∏è</span>
            {% endif %}
            <p class="font-medium">{{ message }}</p>
        </div>
        <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600 font-bold">‚úï</button>
    </div>
    {% endfor %}
</div>
{% endif %}
    <!-- BEGIN: StepperIndicator -->
    <section class="mb-10" data-purpose="progress-tracker">

        <div class="relative flex justify-between items-center max-w-2xl mx-auto">
            <!-- Background Line -->
            <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2 z-0"></div>
            <!-- Progress Line (Controlled by JS) -->
            <div class="absolute top-1/2 left-0 w-0 h-1 bg-primary -translate-y-1/2 z-0 stepper-line"
                id="stepper-progress">
            </div>
            <!-- Step 1 -->
            <div class="relative z-10 flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md ring-4 ring-white"
                    id="step-dot-1">1</div>
                <span class="text-xs font-semibold text-slate-600">Paciente</span>
            </div>
            <!-- Step 2 -->
            <div class="relative z-10 flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold shadow-md ring-4 ring-white"
                    id="step-dot-2">2</div>
                <span class="text-xs font-semibold text-slate-400">Activo</span>
            </div>
            <!-- Step 3 -->
            <div class="relative z-10 flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold shadow-md ring-4 ring-white"
                    id="step-dot-3">3</div>
                <span class="text-xs font-semibold text-slate-400">Receta</span>
            </div>
        </div>
    </section>
    <!-- END: StepperIndicator -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <form method="POST" action="{% url 'create_recipe' %}" id="main-recipe-form">
            {% csrf_token %}
            <input type="hidden" name="paciente_id" id="hidden-paciente-id">
            <input type="hidden" name="activo_id" id="hidden-activo-id">
            <!-- BEGIN: Step1 - Search Patient -->
            <section class="step-content active p-8 md:p-12" id="step-1">
                <div class="max-w-xl mx-auto text-center">
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">Identificar Paciente</h2>
                    <p class="text-slate-500 mb-8">Ingrese el RUT del paciente para iniciar la prescripci√≥n social.</p>
                    <div class="relative mb-8">
                        <input
                            class="w-full px-6 py-4 text-xl rounded-xl border-slate-200 focus:ring-primary focus:border-primary transition-all"
                            id="rut-search" placeholder="12.345.678-9" type="text" />
                        <button type="button"
                            class="absolute right-3 top-3 bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors"
                            onclick="searchPatient()">Buscar</button>
                    </div>
                    <!-- Patient Card (Hidden initially) -->
                    <div class="hidden text-left bg-slate-50 border border-slate-200 rounded-xl p-6 mb-8 animate-fadeIn"
                        id="patient-card">
                        <div class="flex items-start gap-4">
                            <div
                                class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center text-slate-500 text-2xl font-bold">
                                JD
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-slate-900">Juan Delgado P√©rez</h3>
                                <p class="text-slate-500 text-sm mb-4">RUT: 12.345.678-9</p>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="block text-xs uppercase text-slate-400 font-bold">Edad</span>
                                        <span class="text-slate-700 font-medium">67 a√±os</span>
                                    </div>
                                    <div>
                                        <span class="block text-xs uppercase text-slate-400 font-bold">Sector</span>
                                        <span class="text-slate-700 font-medium">Santa Julia</span>
                                    </div>
                                    <div class="col-span-2">
                                        <span class="block text-xs uppercase text-slate-400 font-bold">Direcci√≥n</span>
                                        <span class="text-slate-700 font-medium">Calle Los Aromos #452, Depto 12</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="button"
                            class="px-10 py-3 bg-slate-100 text-slate-400 rounded-xl font-bold cursor-not-allowed transition-all"
                            disabled="" id="next-1" onclick="goToStep(2)">Siguiente</button>
                    </div>
                </div>
            </section>
            <!-- END: Step1 -->
            <!-- BEGIN: Step2 - Community Assets -->
            <section class="step-content p-8" id="step-2">
                <div class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Seleccionar Activo Comunitario</h2>
                        <p class="text-slate-500 text-sm">Activos cercanos al domicilio en Santa Julia</p>
                    </div>
                    <div class="flex gap-2">
                        <select class="rounded-lg border-slate-200 text-sm">
                            <option>Todas las Categor√≠as</option>
                            <option>Actividad F√≠sica</option>
                            <option>Talleres Manuales</option>
                            <option>Apoyo Emocional</option>
                        </select>
                        <select class="rounded-lg border-slate-200 text-sm">
                            <option>Cercan√≠a</option>
                            <option>Disponibilidad</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="assets-grid">
                    <!-- Asset Card 1 -->
                    {% for activo in activos %}
                    <div class="group border border-slate-200 rounded-xl overflow-hidden hover:border-primary transition-all cursor-pointer bg-white"
                        onclick="selectAsset(this, '{{ activo.nombre }}', '{{ activo.id }}')">
                        <img alt="Yoga"
                            class="w-full h-40 object-cover grayscale group-hover:grayscale-0 transition-all"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuD2vkSplnlGhsxUzZEKTI-0YnFfehWG0PUzg_VNEGfN8vlUlfcHFl_SipPduIJumNkONPKN0jB77U-qaw807bOjLEOshc2RGAAp5juehoOl04yAQMtHnESyspM3XOReRUEGJ-CxxJay1Gmn7wJZsCkaunXJMRSqILc6eHyMj75bUi5fYxiLwwUO6F2W3ytAlhx3CDmeS8pCoivk0lyQGSOd2a14lPTwvZKpqG3Aga6TpYffNty_23UphEAedlUGfrjudFlLoA642oQ" />
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <span
                                    class="bg-blue-50 text-primary text-[10px] font-bold uppercase px-2 py-1 rounded">Actividad
                                    F√≠sica</span>
                                <span class="text-xs font-semibold text-slate-500">450m de distancia</span>
                            </div>
                            <h4 class="font-bold text-slate-900 mb-1">Taller de Yoga Adulto Mayor</h4>
                            <p class="text-slate-500 text-xs line-clamp-2">Mejora de movilidad y equilibrio en sede
                                vecinal 14.
                                Monitoreado por kinesi√≥logo.</p>
                            <div class="mt-4 flex items-center text-xs text-slate-400 gap-2">
                                <span class="flex items-center gap-1">üïí Mar-Jue 10:00</span>
                                <span>‚Ä¢</span>
                                <span>Gratuito</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                </div>
                <div class="flex justify-between pt-4 border-t border-slate-100">
                    <button type="button"
                        class="px-6 py-2 text-slate-500 font-bold hover:text-slate-800 transition-colors"
                        onclick="goToStep(1) ">‚Üê Volver
                    </button>
                    <button type="button"
                        class="px-10 py-3 bg-slate-100 text-slate-400 rounded-xl font-bold cursor-not-allowed transition-all"
                        disabled="" id="next-2" onclick="goToStep(3)">Siguiente
                    </button>
                </div>
            </section>
            <!-- END: Step2 -->
            <!-- BEGIN: Step3 - Final Recipe Form -->
            <section class="step-content p-8" id="step-3">
                <div class="flex flex-col lg:flex-row gap-12">
                    <!-- Form Left -->
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold text-slate-900 mb-6">Detalles de la Receta</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Objetivo de Salud</label>
                                <textarea name="objetivo_salud"
                                    class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                    id="health-goal"
                                    placeholder="Ej: Reducir aislamiento social y mejorar movilidad articular..."
                                    rows="3"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Frecuencia</label>
                                    <select name="frecuencia"
                                        class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                        id="frequency">
                                        <option>1 vez por semana</option>
                                        <option selected="">2 veces por semana</option>
                                        <option>Diario</option>
                                        <option>Fin de semana</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Duraci√≥n sugerida</label>
                                    <select name="duracion"
                                        class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                        id="duration">
                                        <option>3 meses</option>
                                        <option selected="">Indefinido</option>
                                        <option>Ciclo de 8 sesiones</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Recomendaciones
                                    adicionales</label>
                                <input name="notas_adicionales"
                                    class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary"
                                    id="notes" placeholder="Ej: Llevar botella de agua y ropa c√≥moda" type="text" />
                            </div>
                        </div>
                        <div class="flex justify-between mt-12 pt-6 border-t border-slate-100">
                            <button class="px-6 py-2 text-slate-500 font-bold hover:text-slate-800 transition-colors"
                                onclick="goToStep(2)">‚Üê Volver</button>
                            <button type="submit"
                                class="px-10 py-3 bg-primary text-white rounded-xl font-bold hover:bg-blue-600 shadow-lg shadow-blue-200 transition-all" ">Emitir Receta Social</button>
                        </div>
                    </div>
                    <!-- Preview Right -->
                    <div class=" lg:w-80 flex flex-col items-center">
                                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">
                                    Previsualizaci√≥n en
                                    Vivo</h3>
                                <!-- BEGIN: Live Preview Card -->
                                <div class="recipe-preview-card w-full max-w-[300px] p-6 rounded-2xl shadow-xl relative overflow-hidden"
                                    data-purpose="invitation-card">
                                    <div class="absolute top-0 left-0 w-full h-2 bg-primary"></div>
                                    <div class="text-center mb-6">
                                        <p class="text-[10px] font-bold text-primary uppercase mb-1">Receta para el
                                            Bienestar
                                        </p>
                                        <h4 class="text-lg font-bold text-slate-900 leading-tight">Invitaci√≥n de Salud
                                        </h4>
                                    </div>
                                    <div class="space-y-4 mb-6">
                                        <div class="border-b border-slate-100 pb-2">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold">Paciente</p>
                                            <p class="text-sm font-bold text-slate-800" id="preview-name">Juan Delgado
                                                P.</p>
                                        </div>
                                        <div class="border-b border-slate-100 pb-2">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold">Actividad Prescrita
                                            </p>
                                            <p class="text-sm font-bold text-primary" id="preview-asset">Seleccione
                                                activo...
                                            </p>
                                        </div>
                                        <div>
                                            <p class="text-[9px] text-slate-400 uppercase font-bold">Indicaci√≥n</p>
                                            <p class="text-xs text-slate-600 italic" id="preview-goal">Complete el
                                                objetivo...
                                            </p>
                                        </div>
                                    </div>
                                    <div
                                        class="bg-white p-3 rounded-lg border border-slate-200 flex flex-col items-center gap-2">
                                        <img alt="QR Link" class="w-24 h-24"
                                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuAtwZvHUfRnk1zEE2tIdQZKvwZXM0uZtAplugUYWlgZXHFwPj7_aZyp8vhg0fIKB7fWMK_mAAdBjURUKboiSilxS_KrAXmCUXawy_ZtlaEpOv72rGdDPWPbCtHmg1NSv3x2yfaW2IW5DD_JwAKDn_Eh-RGnvzgV1E9rnFj0CmO3S0cQwxBtCnvH7PMzTiX2POkxNG0SXOLb3bfw_hNNSJNfIYqEC1ObfbbMF4gkte9m7153XcTELdUWF6MzTZiE66Hj0BDpBay8Wr8" />
                                        <p
                                            class="text-[8px] text-slate-400 text-center uppercase leading-tight font-medium">
                                            Escanee para ver
                                            direcci√≥n y contacto del activo</p>
                                    </div>
                                    <div class="mt-6 text-center">
                                        <p class="text-[10px] text-slate-400">Emitido por: Dr. Ricardo Lagos<br />CESFAM
                                            Santa
                                            Julia</p>
                                    </div>
                                </div>
                                <!-- END: Live Preview Card -->
                        </div>
                    </div>
            </section>
            <!-- END: Step3 -->
    </div>

    <div id="modal-paciente" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl border border-slate-200 w-full max-w-lg overflow-hidden animate-fadeIn">
        <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
            <h3 class="text-xl font-bold text-slate-900">Nuevo Registro de Paciente</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <form id="form-registro-rapido" class="p-6 space-y-4">
            {% csrf_token %}
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">RUT</label>
                    <input type="text" name="rut" id="modal-rut" class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                    <input type="text" name="nombre" class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary" placeholder="Ej: Juan P√©rez" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">F. Nacimiento</label>
                        <input type="date" name="fecha_nacimiento" class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Sector</label>
                        <select name="sector" class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary">
                            <option value="Santa Julia">Santa Julia</option>
                            <option value="Achupallas">Achupallas</option>
                            <option value="Miraflores">Miraflores</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Direcci√≥n</label>
                    <input type="text" name="direccion" class="w-full rounded-xl border-slate-200 focus:ring-primary focus:border-primary" placeholder="Calle #123" required>
                </div>
            </div>
            
            <div class="pt-4 flex gap-3">
                <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all">Cancelar</button>
                <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-bold hover:bg-blue-600 shadow-lg shadow-blue-200 transition-all">
                    Guardar y Seleccionar
                </button>
            </div>
        </form>
    </div>
</div>
</main>
<!-- BEGIN: Logic Scripts -->
<script data-purpose="stepper-logic">
    let currentStep = 1;
    let selectedAssetName = '';

    function goToStep(step) {
        // Hide all steps
        document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
        // Show target step
        document.getElementById(`step-${step}`).classList.add('active');

        // Update Stepper UI
        updateStepperUI(step);
        currentStep = step;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateStepperUI(step) {
        const progress = document.getElementById('stepper-progress');
        const percentage = (step - 1) * 50;
        progress.style.width = `${percentage}%`;

        for (let i = 1; i <= 3; i++) {
            const dot = document.getElementById(`step-dot-${i}`);
            const label = dot.nextElementSibling;

            if (i < step) {
                dot.classList.replace('bg-slate-200', 'bg-primary');
                dot.classList.replace('text-slate-500', 'text-white');
                dot.innerHTML = '‚úì';
            } else if (i === step) {
                dot.classList.replace('bg-slate-200', 'bg-primary');
                dot.classList.replace('text-slate-500', 'text-white');
                dot.innerHTML = i;
                label.classList.replace('text-slate-400', 'text-slate-600');
            } else {
                dot.classList.replace('bg-primary', 'bg-slate-200');
                dot.classList.replace('text-white', 'text-slate-500');
                dot.innerHTML = i;
                label.classList.replace('text-slate-600', 'text-slate-400');
            }
        }
    }

    // 1. B√∫squeda de paciente (A√∫n requiere un peque√±o fetch para no recargar la p√°gina en el paso 1)
// Funciones del Modal
function openModal(rut) {
    document.getElementById('modal-rut').value = rut;
    document.getElementById('modal-paciente').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('modal-paciente').classList.add('hidden');
}

// Modificar tu funci√≥n searchPatient existente
async function searchPatient() {
    const rut = document.getElementById('rut-search').value;
    if (!rut) return;

    try {
        const response = await fetch(`/api/get_paciente/?rut=${rut}`);
        const data = await response.json();

        if (response.ok && data.id) {
            actualizarUIConPaciente(data);
        } else {
            // Si el backend responde 404
            if(confirm("Paciente no encontrado. ¬øDeseas registrarlo ahora?")) {
                openModal(rut);
            }
        }
    } catch (e) {
        console.error("Error:", e);
    }
}

// Nueva funci√≥n para guardar el paciente v√≠a AJAX
document.getElementById('form-registro-rapido').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    try {
        const response = await fetch('/api/crear_paciente_ajax/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();
        if (data.success) {
            closeModal();
            actualizarUIConPaciente(data.paciente); // Selecciona al paciente reci√©n creado
            alert("Paciente creado y seleccionado");
        }
    } catch (error) {
        alert("Error al crear paciente");
    }
};

function actualizarUIConPaciente(paciente) {
    document.getElementById('patient-card').classList.remove('hidden');
    document.getElementById('hidden-paciente-id').value = paciente.id;
    document.getElementById('preview-name').innerText = paciente.nombre;
    document.querySelector('#patient-card h3').innerText = paciente.nombre;
    
    // Activar bot√≥n siguiente
    const nextBtn = document.getElementById('next-1');
    nextBtn.disabled = false;
    nextBtn.classList.replace('bg-slate-100', 'bg-primary');
    nextBtn.classList.replace('text-slate-400', 'text-white');
    nextBtn.classList.remove('cursor-not-allowed');
}

    // 2. Selecci√≥n de Activo
    function selectAsset(element, name, id) {
        // UI: Limpiar otros
        document.querySelectorAll('#assets-grid > div').forEach(card => {
            card.classList.remove('ring-4', 'ring-primary', 'border-primary');
        });

        // Marcar seleccionado
        element.classList.add('ring-4', 'ring-primary', 'border-primary');

        // IMPORTANTE: Guardar el ID real en el input oculto
        document.getElementById('hidden-activo-id').value = id;
        document.getElementById('preview-asset').innerText = name;

        const nextBtn = document.getElementById('next-2');
        nextBtn.disabled = false;
        nextBtn.classList.replace('bg-slate-100', 'bg-primary');
        nextBtn.classList.replace('text-slate-400', 'text-white');
        nextBtn.classList.remove('cursor-not-allowed');
    }
    // Live Preview Update
    document.getElementById('health-goal').addEventListener('input', (e) => {
        document.getElementById('preview-goal').innerText = e.target.value || "Complete el objetivo...";
    });
</script>
<!-- END: Logic Scripts -->
</body>

{% endblock %}